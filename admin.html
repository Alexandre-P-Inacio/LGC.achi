<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Architecture Portfolio</title>
    <link rel="icon" type="image/png" href="assets/logo(2).png">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- jQuery required for Turn.js -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Turn.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>
    <!-- PDF.js for PDF processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Inicializar o cliente Supabase corretamente
        const supabaseUrl = 'https://pwsgmskiamkpzgtlaikm.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c2dtc2tpYW1rcHpndGxhaWttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQzNzM5NzIsImV4cCI6MjA1OTk0OTk3Mn0.oYGnYIpOUteNha2V1EoyhgxDA1XFfzxTjY8jAbSyLmI';
        window.supabase = supabase.createClient(supabaseUrl, supabaseKey);
        console.log('Supabase client initialized in admin.html');
    </script>
    <script src="auth.js" defer></script>
    <script src="admin.js" defer></script>
    <style>
        :root {
            --primary-color: #333;
            --primary-dark: #222;
            --secondary-color: #28a745;
            --accent-color: #000000c9;
            --dark-color: #333;
            --light-color: #f8f9fa;
            --danger-color: #dc3545;
            --warning-color: #fd7e14;
            --success-color: #28a745;
            --border-radius: 12px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        header {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }
        
        .logo {
            font-weight: 700;
            letter-spacing: 1px;
            color: #222;
        }
        
        .nav-links a {
            position: relative;
            transition: var(--transition);
            color: #333;
            text-decoration: none;
        }
        
        .nav-links a:hover {
            color: #000000c9;
        }
        
        .nav-links a:after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -2px;
            left: 0;
            background-color: #000000c9;
            transition: width 0.3s ease;
        }
        
        .nav-links a:hover:after {
            width: 100%;
        }
        
        .admin-main {
            padding: 2rem;
            max-width: 1400px;
            margin: 1rem auto 2rem;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            transition: var(--transition);
            border-left: 4px solid var(--primary-color);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card:nth-child(1) {
            border-left-color: var(--primary-color);
        }
        
        .stat-card:nth-child(2) {
            border-left-color: var(--success-color);
        }
        
        .stat-card:nth-child(3) {
            border-left-color: var(--warning-color);
        }
        
        .stat-card:nth-child(4) {
            border-left-color: var(--danger-color);
        }
        
        .stat-icon {
            font-size: 2rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin-right: 1rem;
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(52, 152, 219, 0.2));
        }
        
        .stat-card:nth-child(1) .stat-icon {
            color: var(--primary-color);
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(52, 152, 219, 0.2));
        }
        
        .stat-card:nth-child(2) .stat-icon {
            color: var(--success-color);
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.1), rgba(46, 204, 113, 0.2));
        }
        
        .stat-card:nth-child(3) .stat-icon {
            color: var(--warning-color);
            background: linear-gradient(135deg, rgba(241, 196, 15, 0.1), rgba(241, 196, 15, 0.2));
        }
        
        .stat-card:nth-child(4) .stat-icon {
            color: var(--danger-color);
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.1), rgba(231, 76, 60, 0.2));
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: var(--dark-color);
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .admin-section {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark-color);
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 0.75rem;
            color: var(--primary-color);
        }
        
        .projects-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .projects-table th {
            background-color: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark-color);
            border-bottom: 2px solid #eee;
        }
        
        .projects-table td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        
        .projects-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .project-title {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 0.25rem;
        }
        
        .project-description {
            color: #7f8c8d;
            font-size: 0.9rem;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 2rem;
            gap: 0.5rem;
        }
        
        .pagination-button {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .pagination-button:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .page-numbers {
            display: flex;
            gap: 0.5rem;
        }
        
        .page-number {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .page-number.active, .page-number:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        footer {
            margin-top: 2rem;
            padding: 2rem;
            background-color: var(--dark-color);
            color: white;
            text-align: center;
        }
        
        /* Additional styles for status badges */
        .status-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        /* Verde para TRUE (Completed) */
        .status-completed {
            background-color: var(--success-color);
            color: white;
        }
        
        /* Amarelo para NULL (In Progress) */
        .status-in-progress {
            background-color: var(--warning-color);
            color: white;
        }
        
        /* Vermelho para FALSE (Incompleted) */
        .status-incompleted {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* Melhorado design dos botões */
        .action-button {
            padding: 0.6rem 1rem;
            background-color: white;
            color: var(--primary-color);
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-weight: 500;
            text-decoration: none;
        }
        
        .action-button:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .action-button:hover i {
            color: white;
        }
        
        .action-button i {
            color: var(--primary-color);
            margin-right: 0.5rem;
            font-size: 1rem;
        }
        
        .delete-button i {
            color: var(--danger-color);
        }
        
        .delete-button:hover {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }
        
        .delete-button:hover i {
            color: white;
        }
        
        .filter-select {
            padding: 0.6rem 1rem;
            border-radius: var(--border-radius);
            border: 1px solid #e0e0e0;
            background-color: white;
            color: var(--dark-color);
            font-family: inherit;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: var(--transition);
        }
        
        .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .search-filter-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .search-container {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 250px;
            max-width: 500px;
            position: relative;
        }
        
        #search-projects {
            width: 100%;
            padding: 0.8rem 1.2rem;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            background-color: #f8f9fa;
            font-size: 0.95rem;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        
        .search-button {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            padding: 0.5rem 0.7rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .search-button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-50%) scale(1.05);
        }
        
        /* Error message styling */
        .no-data {
            padding: 2rem;
            text-align: center;
            color: #7f8c8d;
        }
        
        /* File link styling */
        .file-link {
            color: var(--primary-color);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            transition: var(--transition);
        }
        
        .file-link i {
            margin-right: 0.5rem;
        }
        
        .file-link:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }
        
        /* Add project button styling to match site */
        .add-project-button {
            padding: 0.5rem 1rem;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #333;
            border: 1px solid #333;
            display: inline-flex;
            align-items: center;
            background: transparent;
        }
        
        .add-project-button i {
            margin-right: 0.5rem;
        }
        
        .add-project-button:hover {
            background: #000000c9;  
            color: rgb(255, 255, 255);
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .add-project-button:active {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Styling for reset filters button */
        .reset-filters-button {
            padding: 0.5rem 1rem;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #333;
            border: 1px solid #333;
            display: inline-flex;
            align-items: center;
            background: transparent;
            cursor: pointer;
            margin-top: 15px;
        }
        
        .reset-filters-button i {
            margin-right: 0.5rem;
        }
        
        .reset-filters-button:hover {
            background: #000000c9;  
            color: rgb(255, 255, 255);
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .reset-filters-button:active {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Flipbook additional styles */
        #flipbook-container {
            margin: 0 auto;
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        /* Adjust modal for flipbook */
        .modal-content {
            width: 70%;
            max-width: 900px;
            max-height: 100vh;
            height: 100vh;
        }
        
        /* Add page turning effect */
        ._df_book {
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        }
        
        /* Make file viewer fill available space */
        #file-viewer-container {
            min-height: 600px;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #flipbook-wrapper {
            height: 100%;
            display: flex;
            flex-direction: column;
            flex: 1;
            width: 100%;
        }
        
        #flipbook {
            width: 100%;
            height: 100%;
            flex: 1;
            margin: 0 auto;
            display: none;
        }
        
        #flipbook .page {
            background-color: white;
            background-size: 100% 100%;
            border-radius: 0;
        }
        
        #flipbook .hard {
            background-color: #f5f5f5;
            color: #333;
            text-align: center;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: solid 1px #c2c2c2;
        }
        
        .flipbook-loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 600px;
        }
        
        .modal-loading p {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
        }
        
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #333;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .flipbook-nav {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        
        .flipbook-nav button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            pointer-events: auto;
            opacity: 0.7;
        }
        
        .flipbook-nav button:hover {
            background-color: rgba(0, 0, 0, 0.8);
            opacity: 1;
        }
        
        .flipbook-nav button:disabled {
            background-color: rgba(0, 0, 0, 0.2);
            cursor: not-allowed;
            opacity: 0.3;
        }
        
        #prev-page-btn {
            left: 20px;
        }
        
        #next-page-btn {
            right: 20px;
        }
        
        /* Enhance modal for better mobile experience */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                max-height: 100vh;
                height: 100vh;
            }
            
            #flipbook-container {
                height: 100%;
            }
        }
    </style>
</head>
<body onload="checkAdminAccess(); updateStats(); loadProjects();">
    <header>
        <nav>
            <div class="logo">
                <i class="fas fa-drafting-compass"></i>
                ADMIN DASHBOARD
            </div>
            <ul class="nav-links">
                <li><a href="index.html"><i class="fas fa-arrow-left"></i> Back to Site</a></li>
                <li><span id="admin-name"></span></li>
                <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </nav>
    </header>

    <main class="admin-main">
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-project-diagram"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="total-projects">0</div>
                    <div class="stat-label">Total Projects</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="completed-projects">0</div>
                    <div class="stat-label">Completed</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-spinner"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="in-progress-projects">0</div>
                    <div class="stat-label">In Progress</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="uncompleted-projects">0</div>
                    <div class="stat-label">Incompleted</div>
                </div>
            </div>
        </div>
        
        <section class="admin-section">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-folder-open"></i> Project Management</h2>
                <a href="project-form.html" class="add-project-button">
                    <i class="fas fa-plus"></i> Add New Project
                </a>
            </div>

            <div class="search-filter-container">
                <div class="search-container">
                    <input type="text" id="search-projects" placeholder="Search projects...">
                    <button class="search-button" onclick="searchProjects()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="filter-container">
                    <select id="status-filter" class="filter-select" onchange="filterProjects()">
                        <option value="all">All status</option>
                        <option value="completed">Completed</option>
                        <option value="in_progress">In Progress</option>
                        <option value="incompleted">Incompleted</option>
                    </select>
                </div>
            </div>

            <div class="projects-table-container">
                <table class="projects-table">
                    <thead>
                        <tr>
                            <th>Project Name</th>
                            <th>Category</th>
                            <th>Created</th>
                            <th>File</th>
                            <th>status</th>
                            <th>Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="projects-container">
                        <!-- Projects will be inserted here dynamically -->
                    </tbody>
                </table>
            </div>
            
            <div class="pagination-container">
                <button id="prev-page" class="pagination-button" onclick="loadProjects(currentPage - 1, getCurrentFilters())">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <div id="page-numbers" class="page-numbers">
                    <!-- Page numbers will be inserted here dynamically -->
                </div>
                <button id="next-page" class="pagination-button" onclick="loadProjects(currentPage + 1, getCurrentFilters())">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>
    </main>

    <footer>
        <div class="footer-content">
            <p>&copy; 2025 Architecture Portfolio Admin. All rights reserved.</p>
        </div>
    </footer>

    <!-- File Viewer Modal -->
    <div id="file-viewer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-file-title">File Preview</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="file-info-bar">
                <div class="file-type-icon" id="file-type-icon">DOC</div>
                <span id="file-info">Loading file information...</span>
            </div>
            <div class="modal-body">
                <div id="file-viewer-container">
                    <!-- Turn.js Flipbook container -->
                    <div id="flipbook-wrapper">
                        <div id="flipbook"></div>
                        <div class="flipbook-nav">
                            <button id="prev-page-btn"><i class="fas fa-chevron-left"></i></button>
                            <button id="next-page-btn"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    
                    <!-- Original preview elements -->
                    <iframe id="file-iframe" width="100%" height="600" style="display: none;"></iframe>
                    <img id="file-image" style="display: none;" />
                    <div id="file-unsupported" style="display: none;">
                        <i class="fas fa-file-alt"></i>
                        <h3>This file type cannot be previewed</h3>
                        <p>The file may need to be downloaded to be viewed.</p>
                        <a id="file-download-link" href="#" class="action-button">
                            <i class="fas fa-download"></i> Download File
                        </a>
                    </div>
                    <!-- Loading indicator -->
                    <div class="modal-loading" id="file-loading">
                        <div class="loading-spinner"></div>
                        <p>Loading file...</p>
                    </div>
                </div>
            </div>
            <div class="file-actions">
                <button class="file-action-button" id="zoom-in-button">
                    <i class="fas fa-search-plus"></i> Zoom In
                </button>
                <button class="file-action-button" id="zoom-out-button">
                    <i class="fas fa-search-minus"></i> Zoom Out
                </button>
                <a id="download-button" href="#" class="file-action-button">
                    <i class="fas fa-download"></i> Download
                </a>
            </div>
        </div>
    </div>

    <script>
        // Initialize admin dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Admin page loaded.');
            
            // Check if required libraries are loaded
            const libraryCheck = {
                'jQuery': typeof $ !== 'undefined',
                'Turn.js': typeof $ !== 'undefined' && typeof $.fn.turn !== 'undefined',
                'PDF.js': typeof pdfjsLib !== 'undefined'
            };
            
            console.log('Library check:', libraryCheck);
            
            // Display warning if libraries are missing
            const missingLibraries = Object.keys(libraryCheck).filter(lib => !libraryCheck[lib]);
            if (missingLibraries.length > 0) {
                console.error('Missing libraries:', missingLibraries.join(', '));
                const warning = document.createElement('div');
                warning.style.position = 'fixed';
                warning.style.top = '10px';
                warning.style.right = '10px';
                warning.style.backgroundColor = '#f8d7da';
                warning.style.color = '#721c24';
                warning.style.padding = '10px';
                warning.style.borderRadius = '5px';
                warning.style.zIndex = '9999';
                warning.innerHTML = `Warning: Some libraries failed to load (${missingLibraries.join(', ')}). Flipbook functionality may be limited.`;
                document.body.appendChild(warning);
                
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    warning.style.display = 'none';
                }, 10000);
            }
            
            try {
                await ensureProjectsTable();
                console.log('Projects table check completed');
                
                // Initialize the file viewer modal
                initFileViewer();
            } catch (e) {
                console.error('Error in initial setup:', e);
            }
        });
        
        // Initialize file viewer modal
        function initFileViewer() {
            // Get modal elements
            const modal = document.getElementById('file-viewer-modal');
            const closeBtn = modal.querySelector('.close-modal');
            const flipbook = document.getElementById('flipbook');
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');
            
            // Configure PDF.js worker
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
                console.log('PDF.js worker configured successfully');
            } else {
                console.error('PDF.js library not loaded properly!');
            }
            
            // Make the flipbook responsive
            window.addEventListener('resize', function() {
                if (flipbook && $(flipbook).turn("is")) {
                    const parent = flipbook.parentElement;
                    if (parent) {
                        const width = parent.clientWidth * 0.9;
                        $(flipbook).turn("size", width, 600);
                    }
                }
            });
            
            // Close modal when clicking the close button
            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                
                // Destroy any existing flipbook
                if (flipbook && $(flipbook).turn("is")) {
                    $(flipbook).turn("destroy");
                    flipbook.innerHTML = '';
                }
            });
            
            // Close modal when clicking outside the modal content
            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                    
                    // Destroy any existing flipbook
                    if (flipbook && $(flipbook).turn("is")) {
                        $(flipbook).turn("destroy");
                        flipbook.innerHTML = '';
                    }
                }
            });
            
            // Navigation buttons for flipbook - using multiple binding methods for maximum compatibility
            if (typeof $ !== 'undefined') {
                // jQuery binding
                $(prevBtn).off('click').on('click', function(e) {
                    e.preventDefault();
                    try {
                        console.log('Previous button clicked');
                        // Get current page
                        const currentPage = $(flipbook).turn('page');
                        console.log('Current page before previous:', currentPage);
                        
                        // Go to exactly one page back
                        if (currentPage > 1) {
                            $(flipbook).turn('page', currentPage - 1);
                        }
                    } catch (err) {
                        console.error('Error on previous button:', err);
                    }
                    return false;
                });
                
                $(nextBtn).off('click').on('click', function(e) {
                    e.preventDefault();
                    try {
                        console.log('Next button clicked');
                        // Get current page
                        const currentPage = $(flipbook).turn('page');
                        console.log('Current page before next:', currentPage);
                        
                        // Go to exactly one page forward
                        const totalPages = numPages + 2; // +2 for covers
                        if (currentPage < totalPages) {
                            $(flipbook).turn('page', currentPage + 1);
                        }
                    } catch (err) {
                        console.error('Error on next button:', err);
                    }
                    return false;
                });
            }
            
            // Also add standard event listeners as backup
            prevBtn.addEventListener('click', function(e) {
                if (flipbook && $(flipbook).turn("is")) {
                    $(flipbook).turn("previous");
                }
                e.preventDefault();
            });
            
            nextBtn.addEventListener('click', function(e) {
                if (flipbook && $(flipbook).turn("is")) {
                    $(flipbook).turn("next");
                }
                e.preventDefault();
            });
            
            // Initialize zoom controls
            const zoomInButton = document.getElementById('zoom-in-button');
            const zoomOutButton = document.getElementById('zoom-out-button');
            const imgPreview = document.getElementById('file-image');
            
            let currentZoom = 1;
            
            zoomInButton.addEventListener('click', function() {
                if (currentZoom < 3) {
                    currentZoom += 0.2;
                    imgPreview.style.transform = `scale(${currentZoom})`;
                }
            });
            
            zoomOutButton.addEventListener('click', function() {
                if (currentZoom > 0.5) {
                    currentZoom -= 0.2;
                    imgPreview.style.transform = `scale(${currentZoom})`;
                }
            });
        }
        
        // Show file in modal with appropriate preview based on file type
        function showFileInModal(fileUrl, fileName) {
            const modal = document.getElementById('file-viewer-modal');
            const title = document.getElementById('modal-file-title');
            const iframe = document.getElementById('file-iframe');
            const imgPreview = document.getElementById('file-image');
            const unsupportedView = document.getElementById('file-unsupported');
            const downloadLink = document.getElementById('file-download-link');
            const downloadButton = document.getElementById('download-button');
            const fileLoading = document.getElementById('file-loading');
            const fileInfo = document.getElementById('file-info');
            const fileTypeIcon = document.getElementById('file-type-icon');
            const zoomInButton = document.getElementById('zoom-in-button');
            const zoomOutButton = document.getElementById('zoom-out-button');
            const flipbook = document.getElementById('flipbook');
            const flipbookWrapper = document.getElementById('flipbook-wrapper');
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');
            
            // Reset zoom
            imgPreview.style.transform = 'scale(1)';
            
            // Show loading indicator
            fileLoading.style.display = 'flex';
            
            // Hide all preview elements initially
            iframe.style.display = 'none';
            imgPreview.style.display = 'none';
            unsupportedView.style.display = 'none';
            flipbookWrapper.style.display = 'none';
            flipbook.style.display = 'none';
            
            // Reset flipbook container
            flipbook.innerHTML = '';
            
            // Set the modal title to the file name
            title.textContent = fileName || 'File Preview';
            
            // Set download links
            downloadLink.href = fileUrl;
            downloadLink.setAttribute('download', fileName || 'download');
            downloadButton.href = fileUrl;
            downloadButton.setAttribute('download', fileName || 'download');
            
            // Determine file type and update file info
            const fileExtension = fileName.split('.').pop().toLowerCase();
            const fileTypeMap = {
                'jpg': { type: 'Image', icon: 'JPG', color: '#3a7bd5' },
                'jpeg': { type: 'Image', icon: 'JPG', color: '#3a7bd5' },
                'png': { type: 'Image', icon: 'PNG', color: '#28a745' },
                'gif': { type: 'Image', icon: 'GIF', color: '#fd7e14' },
                'svg': { type: 'Image', icon: 'SVG', color: '#6610f2' },
                'webp': { type: 'Image', icon: 'WP', color: '#20c997' },
                'pdf': { type: 'Document', icon: 'PDF', color: '#dc3545' },
                'txt': { type: 'Text', icon: 'TXT', color: '#6c757d' },
                'html': { type: 'Code', icon: 'HTML', color: '#e83e8c' },
                'htm': { type: 'Code', icon: 'HTML', color: '#e83e8c' },
                'css': { type: 'Code', icon: 'CSS', color: '#007bff' },
                'js': { type: 'Code', icon: 'JS', color: '#ffc107' },
                'doc': { type: 'Document', icon: 'DOC', color: '#007bff' },
                'docx': { type: 'Document', icon: 'DOCX', color: '#007bff' }
            };
            
            const fileType = fileTypeMap[fileExtension] || { type: 'Unknown', icon: 'FILE', color: '#6c757d' };
            fileInfo.textContent = `${fileType.type} • ${formatFileSize(1024 * 1024)} • ${formatDate(new Date())}`;
            fileTypeIcon.textContent = fileType.icon;
            fileTypeIcon.style.background = fileType.color;
            
            // Show or hide zoom buttons based on file type
            const canZoom = ['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp'].includes(fileExtension);
            zoomInButton.style.display = canZoom ? 'flex' : 'none';
            zoomOutButton.style.display = canZoom ? 'flex' : 'none';
            
            // Choose appropriate preview based on file extension
            if (['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp'].includes(fileExtension)) {
                // Image preview
                imgPreview.onload = function() {
                    fileLoading.style.display = 'none';
                    imgPreview.style.display = 'block';
                };
                imgPreview.onerror = function() {
                    fileLoading.style.display = 'none';
                    unsupportedView.style.display = 'block';
                };
                imgPreview.src = fileUrl;
            } 
            else if (['pdf'].includes(fileExtension)) {
                // PDF Flipbook using PDF.js and Turn.js
                flipbookWrapper.style.display = 'block';
                
                try {
                    console.log('Starting PDF processing for flipbook');
                    // First check if libraries are loaded
                    if (typeof pdfjsLib === 'undefined') {
                        throw new Error('PDF.js library not loaded');
                    }
                    
                    if (typeof $ === 'undefined' || typeof $.fn.turn === 'undefined') {
                        throw new Error('Turn.js library not loaded');
                    }
                    
                    // Load the PDF file
                    console.log('Loading PDF from URL:', fileUrl);
                    pdfjsLib.getDocument(fileUrl).promise.then(function(pdf) {
                        console.log('PDF loaded successfully with', pdf.numPages, 'pages');
                        
                        // Create pages for the flipbook
                        const numPages = pdf.numPages;
                        const pagesPromises = [];
                        
                        // Clear existing content first
                        flipbook.innerHTML = '';
                        
                        // Initialize the flipbook with only the exact required pages
                        for (let i = 1; i <= numPages; i++) {
                            const pageDiv = document.createElement('div');
                            pageDiv.className = 'page';
                            pageDiv.id = `page-${i}`;
                            pageDiv.style.position = 'relative';
                            pageDiv.style.overflow = 'hidden';
                            
                            // Loading placeholder
                            const placeholder = document.createElement('div');
                            placeholder.style.position = 'absolute';
                            placeholder.style.top = '50%';
                            placeholder.style.left = '50%';
                            placeholder.style.transform = 'translate(-50%, -50%)';
                            placeholder.style.color = '#999';
                            placeholder.textContent = `Loading page ${i}...`;
                            pageDiv.appendChild(placeholder);
                            
                            // Page number for reference
                            const pageNumber = document.createElement('div');
                            pageNumber.textContent = i;
                            pageNumber.style.position = 'absolute';
                            pageNumber.style.bottom = '10px';
                            pageNumber.style.right = '10px';
                            pageNumber.style.fontSize = '12px';
                            pageNumber.style.color = '#999';
                            pageNumber.style.zIndex = '100';
                            pageDiv.appendChild(pageNumber);
                            
                            flipbook.appendChild(pageDiv);
                        }
                        
                        // Initialize the flipbook 
                        $(flipbook).turn({
                            width: 800,
                            height: '100%',
                            autoCenter: true,
                            display: 'single', // Force single page mode
                            duration: 600,
                            acceleration: false, // Disable acceleration which can cause issues
                            gradients: true,
                            elevation: 50,
                            page: 1, // Start at page 1
                            when: {
                                turning: function(event, page, view) {
                                    console.log(`Turning to page ${page}, view:`, view);
                                    
                                    // Load current and adjacent pages
                                    loadPageContent(page);
                                    if (page > 1) loadPageContent(page - 1);
                                    if (page < numPages) loadPageContent(page + 1);
                                },
                                turned: function(event, page, view) {
                                    console.log(`Turned to page ${page}, view:`, view);
                                    
                                    // Update navigation button states
                                    prevBtn.disabled = page <= 1;
                                    nextBtn.disabled = page >= numPages;
                                    
                                    // Show current page in console
                                    console.log(`Current page is now ${page} of ${numPages}`);
                                }
                            }
                        });
                        
                        // Function to directly render PDF page to a canvas
                        async function loadPageContent(pageNum) {
                            if (pageNum < 1 || pageNum > numPages) return; // Skip invalid pages
                            
                            const pageDiv = document.getElementById(`page-${pageNum}`);
                            if (!pageDiv || pageDiv.querySelector('canvas')) return; // Skip if already loaded
                            
                            try {
                                // Get the page from PDF
                                const page = await pdf.getPage(pageNum);
                                
                                // Calculate scale to fit
                                const viewport = page.getViewport({scale: 1.0});
                                const containerWidth = 750; // Fixed container width
                                const containerHeight = 550; // Fixed container height
                                
                                // Calculate scale to fit
                                const scaleX = containerWidth / viewport.width;
                                const scaleY = containerHeight / viewport.height;
                                const scale = Math.min(scaleX, scaleY) * 0.95; // 95% to leave margin
                                
                                const scaledViewport = page.getViewport({scale});
                                
                                // Create canvas
                                const canvas = document.createElement('canvas');
                                canvas.width = scaledViewport.width;
                                canvas.height = scaledViewport.height;
                                
                                // Center canvas in page
                                canvas.style.position = 'absolute';
                                canvas.style.top = '50%';
                                canvas.style.left = '50%';
                                canvas.style.transform = 'translate(-50%, -50%)';
                                canvas.style.border = '1px solid #eee';
                                
                                // Remove loading placeholder and add canvas
                                pageDiv.innerHTML = '';
                                pageDiv.appendChild(canvas);
                                
                                // Add page number indicator
                                const pageNumber = document.createElement('div');
                                pageNumber.textContent = pageNum;
                                pageNumber.style.position = 'absolute';
                                pageNumber.style.bottom = '10px';
                                pageNumber.style.right = '10px';
                                pageNumber.style.fontSize = '12px';
                                pageNumber.style.color = '#333';
                                pageNumber.style.background = 'rgba(255,255,255,0.7)';
                                pageNumber.style.padding = '3px 8px';
                                pageNumber.style.borderRadius = '10px';
                                pageDiv.appendChild(pageNumber);
                                
                                // Render PDF page to canvas
                                const context = canvas.getContext('2d');
                                await page.render({
                                    canvasContext: context,
                                    viewport: scaledViewport
                                }).promise;
                                
                                console.log(`Rendered page ${pageNum} at scale ${scale.toFixed(2)}`);
            } catch (error) {
                                console.error(`Error rendering page ${pageNum}:`, error);
                                pageDiv.innerHTML = `<div style="padding: 20px; text-align: center;">
                                    Error loading page ${pageNum}<br>
                                    <small>${error.message}</small>
                                </div>`;
                            }
                        }
                        
                        // Load first few pages immediately
                        for (let i = 1; i <= Math.min(3, numPages); i++) {
                            loadPageContent(i);
                        }
                        
                        // Hide loading indicator
                        fileLoading.style.display = 'none';
                        flipbook.style.display = 'block';
                        
                        // Update button states
                        prevBtn.disabled = true; // Start at first page
                        nextBtn.disabled = numPages <= 1;
                        
                        // Add simple and direct click handlers for navigation
                        $(prevBtn).off('click').on('click', function() {
                            const currentPage = $(flipbook).turn('page');
                            console.log(`Previous clicked. Current page: ${currentPage}`);
                            
                            if (currentPage > 1) {
                                // Go to the exact previous page
                                const targetPage = currentPage - 1;
                                console.log(`Navigating to previous page: ${targetPage}`);
                                $(flipbook).turn('page', targetPage);
                            }
                            return false;
                        });
                        
                        $(nextBtn).off('click').on('click', function() {
                            const currentPage = $(flipbook).turn('page');
                            console.log(`Next clicked. Current page: ${currentPage}`);
                            
                            if (currentPage < numPages) {
                                // Go to the exact next page
                                const targetPage = currentPage + 1;
                                console.log(`Navigating to next page: ${targetPage}`);
                                $(flipbook).turn('page', targetPage);
                            }
                            return false;
                        });
                    }).catch(function(error) {
                        console.error('Error loading PDF:', error);
                        fallbackToPdfViewer(fileUrl);
                    });
                    } catch (e) {
                    console.error('General error in PDF processing:', e);
                    fallbackToPdfViewer(fileUrl);
                }
                
                // Fallback function for PDF viewing
                function fallbackToPdfViewer(pdfUrl) {
                    console.log('Using fallback PDF viewer');
                    fileLoading.style.display = 'none';
                    flipbookWrapper.style.display = 'none';
                    
                    // Try to display PDF in iframe
                iframe.onload = function() {
                    fileLoading.style.display = 'none';
                    iframe.style.display = 'block';
                };
                iframe.onerror = function() {
                    fileLoading.style.display = 'none';
                    unsupportedView.style.display = 'block';
                };
                    iframe.src = pdfUrl;
                }
            }
            else if (['doc', 'docx'].includes(fileExtension)) {
                // For Word documents, convert to PDF online and then use the PDF viewer
                // In a real implementation, you would use a service that converts DOCX to PDF or HTML
                // Here we use the Office Online Viewer as a simpler alternative
                iframe.onload = function() {
                    fileLoading.style.display = 'none';
                    iframe.style.display = 'block';
                };
                iframe.onerror = function() {
                    fileLoading.style.display = 'none';
                    unsupportedView.style.display = 'block';
                };
                const encodedUrl = encodeURIComponent(fileUrl);
                iframe.src = `https://view.officeapps.live.com/op/view.aspx?src=${encodedUrl}`;
            }
            else if (['txt', 'html', 'htm', 'css', 'js'].includes(fileExtension)) {
                // Text files in iframe 
                iframe.onload = function() {
                    fileLoading.style.display = 'none';
                    iframe.style.display = 'block';
                };
                iframe.onerror = function() {
                    fileLoading.style.display = 'none';
                    unsupportedView.style.display = 'block';
                };
                iframe.src = fileUrl;
            }
            else {
                // Unsupported file type - show download option
                fileLoading.style.display = 'none';
                unsupportedView.style.display = 'block';
            }
            
            // Show the modal
            modal.style.display = 'block';
        }
        
        // Helper function to format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        // Helper function to format date
        function formatDate(date) {
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
    </script>
</body>
</html> 