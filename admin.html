<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Architecture Portfolio</title>
    <link rel="icon" type="image/png" href="assets/logo(2).png">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Inicializar o cliente Supabase corretamente
        const supabaseUrl = 'https://pwsgmskiamkpzgtlaikm.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c2dtc2tpYW1rcHpndGxhaWttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQzNzM5NzIsImV4cCI6MjA1OTk0OTk3Mn0.oYGnYIpOUteNha2V1EoyhgxDA1XFfzxTjY8jAbSyLmI';
        window.supabase = supabase.createClient(supabaseUrl, supabaseKey);
        console.log('Supabase client initialized in admin.html');
    </script>
    <script src="auth.js" defer></script>
    <script src="admin.js" defer></script>
</head>
<body>
    <header>
        <nav>
            <div class="logo">
                <i class="fas fa-drafting-compass"></i>
                ADMIN DASHBOARD
            </div>
            <ul class="nav-links">
                <li><a href="index.html"><i class="fas fa-home"></i> Back to Site</a></li>
                <li><span id="admin-name">Welcome, admin</span></li>
                <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </nav>
    </header>

    <main class="admin-main">
        <!-- Stats Cards -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-project-diagram"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="total-projects">0</div>
                    <div class="stat-label">Total Projects</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="completed-projects">0</div>
                    <div class="stat-label">Completed</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-spinner"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="in-progress-projects">0</div>
                    <div class="stat-label">In Progress</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="uncompleted-projects">0</div>
                    <div class="stat-label">Uncompleted</div>
                </div>
            </div>
        </div>
        
        <!-- Project Management Section -->
        <section class="admin-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-tasks"></i> Project Management
                </div>
            </div>

            <!-- Search and filters -->
            <div class="search-filter-container">
                <div class="search-container">
                    <input type="text" id="search-projects" placeholder="Search projects...">
                    <button id="search-button" class="search-button">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="filter-container">
                    <select id="status-filter" class="filter-select">
                        <option value="all">All Statuses</option>
                        <option value="completed">Completed</option>
                        <option value="in_progress">In Progress</option>
                        <option value="uncompleted">Uncompleted</option>
                    </select>
                </div>
            </div>

            <!-- Projects Table -->
            <div class="projects-table-container">
                <table class="projects-table">
                    <thead>
                        <tr>
                            <th>Project Name</th>
                            <th>Date Added</th>
                            <th>File</th>
                            <th>Status</th>
                            <th>Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="projects-container">
                        <!-- Projects will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination-container">
                <button class="pagination-button" id="prev-page"><i class="fas fa-chevron-left"></i></button>
                <div class="page-numbers" id="page-numbers">
                    <button class="page-number active">1</button>
                    <button class="page-number">2</button>
                    <button class="page-number">3</button>
                </div>
                <button class="pagination-button" id="next-page"><i class="fas fa-chevron-right"></i></button>
            </div>
        </section>
    </main>

    <footer>
        <div class="footer-content">
            <p>&copy; 2025 Architecture Portfolio Admin. All rights reserved.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadProjects();
            updateStats();
            
            // Manter apenas os event listeners necessários
            document.getElementById('search-button').addEventListener('click', filterProjects);
            
            document.getElementById('search-projects').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    filterProjects();
                }
            });
            
            document.getElementById('status-filter').addEventListener('change', filterProjects);
        });
        
        async function loadProjects() {
            try {
                const { data, error } = await window.supabase
                    .from('architecture_projects')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const projectsContainer = document.getElementById('projects-container');
                projectsContainer.innerHTML = '';
                
                if (!data || data.length === 0) {
                    projectsContainer.innerHTML = `
                        <tr>
                            <td colspan="6" class="no-data">No projects found</td>
                        </tr>
                    `;
                    return;
                }
                
                data.forEach(project => {
                    // Determine status text and class based on status column
                    let statusText, statusClass;
                    
                    if (project.status === true) {
                        statusText = 'Completed';
                        statusClass = 'status-completed';
                    } else if (project.status === false) {
                        statusText = 'Uncompleted';
                        statusClass = 'status-uncompleted';
                    } else if (project.status === null) {
                        statusText = 'In Progress';
                        statusClass = 'status-in-progress';
                    }
                    
                    const row = document.createElement('tr');
                    
                    // Format date
                    const createdDate = new Date(project.created_at);
                    const formattedDate = createdDate.toLocaleDateString();
                    
                    // Determine if there's a file
                    const fileDisplay = project.ficheiro_url 
                        ? `<a href="${project.ficheiro_url}" target="_blank" class="file-link"><i class="fas fa-file"></i> View</a>` 
                        : 'No file';
                    
                    row.innerHTML = `
                        <td>
                            <div class="project-title">${project.nome || 'Untitled'}</div>
                            <div class="project-description">${project.descricao || ''}</div>
                        </td>
                        <td>${formattedDate}</td>
                        <td>${fileDisplay}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${project.project_type || 'N/A'}</td>
                        <td>
                            <div class="action-buttons">
                                <a href="project-form.html?id=${project.id_projeto}" class="action-button edit-button" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="action-button delete-button" onclick="deleteProject('${project.id_projeto}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    projectsContainer.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading projects:', error);
                // Show error message to user
            }
        }
        
        async function updateStats() {
            try {
                const { data, error } = await window.supabase
                    .from('architecture_projects')
                    .select('status');
                
                if (error) throw error;
                
                console.log('Status data:', data); // Debug log
                
                // Calcular estatísticas corretamente
                const totalProjects = data.length;
                const completedProjects = data.filter(p => p.status === true).length;
                const inProgressProjects = data.filter(p => p.status === null).length;
                const uncompletedProjects = data.filter(p => p.status === false).length;
                
                console.log('Stats:', {
                    total: totalProjects,
                    completed: completedProjects,
                    inProgress: inProgressProjects,
                    uncompleted: uncompletedProjects
                });
                
                // Atualizar UI
                document.getElementById('total-projects').textContent = totalProjects;
                document.getElementById('completed-projects').textContent = completedProjects;
                document.getElementById('in-progress-projects').textContent = inProgressProjects;
                document.getElementById('uncompleted-projects').textContent = uncompletedProjects;
                
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }
        
        async function filterProjects() {
            const searchTerm = document.getElementById('search-projects').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            
            console.log('Status filter selected:', statusFilter); // Debug
            
            try {
                let query = window.supabase
                    .from('architecture_projects')
                    .select('*');
                
                // Aplicar filtro de status
                if (statusFilter !== 'all') {
                    switch (statusFilter) {
                        case 'completed':
                            query = query.eq('status', true);
                            break;
                        case 'uncompleted':
                            query = query.eq('status', false);
                            break;
                        case 'in_progress':
                            query = query.is('status', null);
                            break;
                    }
                }
                
                const { data, error } = await query.order('created_at', { ascending: false });
                
                if (error) throw error;
                
                console.log('Filtered data:', data); // Debug
                
                const projectsContainer = document.getElementById('projects-container');
                projectsContainer.innerHTML = '';
                
                // Aplicar filtro de busca se houver termo de busca
                let filteredData = data;
                if (searchTerm) {
                    filteredData = data.filter(project => 
                        (project.nome && project.nome.toLowerCase().includes(searchTerm)) || 
                        (project.descricao && project.descricao.toLowerCase().includes(searchTerm))
                    );
                }
                
                if (filteredData.length === 0) {
                    projectsContainer.innerHTML = `
                        <tr>
                            <td colspan="6" class="no-data">No projects found matching your criteria</td>
                        </tr>
                    `;
                    return;
                }
                
                // Renderizar os projetos filtrados
                filteredData.forEach(project => {
                    let statusText, statusClass;
                    
                    if (project.status === true) {
                        statusText = 'Completed';
                        statusClass = 'status-completed';
                    } else if (project.status === false) {
                        statusText = 'Uncompleted';
                        statusClass = 'status-uncompleted';
                    } else if (project.status === null) {
                        statusText = 'In Progress';
                        statusClass = 'status-in-progress';
                    }
                    
                    const row = document.createElement('tr');
                    
                    // Format date
                    const createdDate = new Date(project.created_at);
                    const formattedDate = createdDate.toLocaleDateString();
                    
                    // Determine if there's a file
                    const fileDisplay = project.ficheiro_url 
                        ? `<a href="${project.ficheiro_url}" target="_blank" class="file-link"><i class="fas fa-file"></i> View</a>` 
                        : 'No file';
                    
                    row.innerHTML = `
                        <td>
                            <div class="project-title">${project.nome || 'Untitled'}</div>
                            <div class="project-description">${project.descricao || ''}</div>
                        </td>
                        <td>${formattedDate}</td>
                        <td>${fileDisplay}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${project.project_type || 'N/A'}</td>
                        <td>
                            <div class="action-buttons">
                                <a href="project-form.html?id=${project.id_projeto}" class="action-button edit-button" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="action-button delete-button" onclick="deleteProject('${project.id_projeto}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    projectsContainer.appendChild(row);
                });
            } catch (error) {
                console.error('Error filtering projects:', error);
            }
        }
    </script>

    <style>
        /* Atualizar os estilos dos status badges */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        /* Verde suave para Completed */
        .status-completed {
            background-color: rgba(40, 167, 69, 0.15);
            color: #2d8a46;
            border: 1px solid rgba(40, 167, 69, 0.2);
        }
        
        /* Amarelo suave para In Progress */
        .status-in-progress {
            background-color: rgba(255, 193, 7, 0.15);
            color: #b78502;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }
        
        /* Vermelho suave para Uncompleted */
        .status-uncompleted {
            background-color: rgba(220, 53, 69, 0.15);
            color: #c93b4a;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }
        
        .filter-select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: white;
            margin-left: 10px;
        }
        
        .search-filter-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .search-container {
            display: flex;
            align-items: center;
        }
        
        #search-projects {
            padding: 8px 12px;
            border-radius: 4px 0 0 4px;
            border: 1px solid #ddd;
            border-right: none;
            width: 250px;
        }
        
        .search-button {
            padding: 8px 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
    </style>
</body>
</html> 